<%- include('partials/header', { 
  title: 'Find Rides', 
  email, 
  firstName, 
  lastName, 
  admin,
  currentPage: 'find-rides'
}) %>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="fas fa-car-side me-2"></i>Find Rides Near You</h2>
                </div>
                <div class="card-body">
                    <p class="text-muted">Search for students who live near you to arrange carpools to school events.</p>
                    
                    <form id="findRidesForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="studentName" 
                                           placeholder="Enter student's full name" required
                                           value="<%= firstName && lastName ? `${firstName} ${lastName}` : '' %>">
                                    <label for="studentName">Student Name</label>
                                    <div class="invalid-feedback">
                                        Please enter a student name.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <select class="form-select" id="maxDistance" required>
                                        <option value="0.5">0.5 miles</option>
                                        <option value="1" selected>1 mile</option>
                                        <option value="2">2 miles</option>
                                        <option value="5">5 miles</option>
                                        <option value="10">10 miles</option>
                                    </select>
                                    <label for="maxDistance">Maximum Distance</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-search me-2"></i> Find Rides
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="text-center my-5 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Searching for nearby students...</p>
            </div>

            <!-- Results Section -->
            <div id="results" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h5 mb-0">
                        <i class="fas fa-users me-2"></i>Nearby Students
                    </h3>
                    <span id="resultCount" class="badge bg-primary rounded-pill"></span>
                </div>
                
                <div id="studentResults" class="row g-4">
                    <!-- Results will be populated here -->
                </div>
                
                <div id="noResults" class="alert alert-info mt-4 d-none">
                    <i class="fas fa-info-circle me-2"></i>
                    No students found within the specified distance. Try increasing the search radius.
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error" class="alert alert-danger mt-4 d-none">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorMessage">An error occurred while searching for rides. Please try again.</span>
            </div>
        </div>
    </div>
</div>

<script>
// Form validation and submission handling
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('findRidesForm');
    const results = document.getElementById('results');
    const noResults = document.getElementById('noResults');
    const error = document.getElementById('error');
    const loading = document.getElementById('loading');
    const studentResults = document.getElementById('studentResults');
    const resultCount = document.getElementById('resultCount');
    const errorMessage = document.getElementById('errorMessage');
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Check form validity
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        // Reset UI
        results.classList.add('d-none');
        noResults.classList.add('d-none');
        error.classList.add('d-none');
        loading.classList.remove('d-none');
        
        const studentName = document.getElementById('studentName').value.trim();
        const maxDistance = document.getElementById('maxDistance').value;
        
        try {
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Searching...';
            
            const response = await fetch('/find-rides/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ studentName, maxDistance })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to find rides');
            }
            
            // Display results
            if (data.nearbyStudents && data.nearbyStudents.length > 0) {
                displayResults(data);
                results.classList.remove('d-none');
            } else {
                noResults.classList.remove('d-none');
                results.classList.remove('d-none');
            }
            
        } catch (err) {
            console.error('Error:', err);
            error.classList.remove('d-none');
        }
    });
    
    // Handle copy contact info button
    document.addEventListener('click', function(e) {
        if (e.target.closest('.copy-contact')) {
            const contactInfo = e.target.closest('.copy-contact').getAttribute('data-contact');
            if (contactInfo) {
                navigator.clipboard.writeText(contactInfo).then(() => {
                    const originalText = e.target.closest('.copy-contact').innerHTML;
                    e.target.closest('.copy-contact').innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        e.target.closest('.copy-contact').innerHTML = originalText;
                    }, 2000);
                });
            }
        }
    });
    
    function showError(message) {
        error.textContent = message;
        error.classList.remove('d-none');
    }
    
    // Function to display search results
    function displayResults(data) {
        const { student, nearbyStudents } = data;
        
        // Update result count
        resultCount.textContent = nearbyStudents.length;
        
        // Clear previous results
        studentResults.innerHTML = '';
        
        // Add each student to the results
        nearbyStudents.forEach(student => {
            const studentCard = document.createElement('div');
            studentCard.className = 'col-12';
            studentCard.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-1">${student.name}</h5>
                                <p class="text-muted small mb-2">${student.grade || 'Grade not specified'}</p>
                            </div>
                            <span class="badge bg-primary">${student.distance} miles</span>
                        </div>
                        
                        <div class="mb-2">
                            <p class="mb-1"><strong>Parent:</strong> ${student.parentName || 'N/A'}</p>
                            <p class="mb-1"><strong>Address:</strong> ${student.address || 'N/A'}</p>
                            <p class="mb-0"><strong>Contact:</strong> ${student.contactInfo || 'N/A'}</p>
                        </div>
                        
                        ${student.contactInfo ? `
                            <div class="mt-3">
                                <a href="mailto:${student.contactInfo}" class="btn btn-sm btn-outline-primary me-2"
                                   data-bs-toggle="tooltip" data-bs-placement="top" title="Email ${student.name}'s parent">
                                    <i class="fas fa-envelope me-1"></i> Email
                                </a>
                                <button class="btn btn-sm btn-outline-secondary copy-contact" 
                                        data-contact="${student.contactInfo}"
                                        data-bs-toggle="tooltip" data-bs-placement="top" 
                                        title="Copy email to clipboard">
                                    <i class="fas fa-copy me-1"></i> Copy Email
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            studentResults.appendChild(studentCard);
        });
        
        // Initialize tooltips for dynamically added elements
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add click handler for copy email buttons
        document.querySelectorAll('.copy-contact').forEach(button => {
            button.addEventListener('click', function() {
                const email = this.getAttribute('data-contact');
                navigator.clipboard.writeText(email).then(() => {
                    // Show tooltip with success message
                    const tooltip = bootstrap.Tooltip.getInstance(this);
                    const originalTitle = this.getAttribute('data-bs-original-title');
                    this.setAttribute('data-bs-original-title', 'Email copied!');
                    tooltip.show();
                    
                    // Revert tooltip after delay
                    setTimeout(() => {
                        this.setAttribute('data-bs-original-title', originalTitle);
                        tooltip.hide();
                    }, 2000);
                });
            });
        });
    }
});
</script>

<%- include('partials/footer') %>
